<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MONTBLOCK ‚Äì Factory System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;margin:0;background:#f4f4f4}
header{background:#000;color:#fff;padding:15px;text-align:center;font-weight:bold}
nav{display:flex;flex-wrap:wrap;justify-content:space-around;background:#e0e0e0;padding:10px}
nav button{padding:10px;border:none;background:#000;color:#fff;border-radius:4px;margin:3px}
section{padding:15px}
.card{background:#fff;padding:12px;margin-bottom:12px;border-radius:6px}
input,select{width:100%;padding:8px;margin:6px 0}
hr{border:none;border-top:1px solid #ccc;margin:15px 0}
.small{font-size:13px;color:#555}
.edit{color:#0066cc;cursor:pointer;font-weight:bold}
.alert{color:#b00020;font-weight:bold}
</style>
</head>

<body>

<header>MONTBLOCK ‚Äì Factory System</header>

<nav>
<button onclick="show('dash')">Dashboard</button>
<button onclick="show('cement')">Cement</button>
<button onclick="show('prod')">Production</button>
<button onclick="show('sale')">Sales</button>
<button onclick="show('exp')">Expenses</button>
<button onclick="show('history')">History</button>
<button onclick="show('report')">Reports</button>
<button onclick="exportJSON()">Export</button>
<button onclick="importJSON()">Import</button>
</nav>

<section id="dash" class="card"></section>

<section id="cement" class="card" style="display:none">
<h3>üèóÔ∏è Cement IN</h3>
<input id="cdate" type="date">
<input id="cbags" type="number" placeholder="Bags purchased">
<input id="cprice" type="number" placeholder="Price per bag">
<button onclick="saveCementIn()">Save Cement IN</button>

<hr>

<h3>üß™ Cement OUT</h3>
<input id="coutdate" type="date">
<input id="coutbags" type="number" placeholder="Bags used / wasted">
<input id="coutreason" placeholder="Reason (optional)">
<button onclick="saveCementOut()">Save Cement OUT</button>
</section>

<section id="prod" class="card" style="display:none">
<h3>üß± Block Production</h3>
<input id="pdate" type="date">
<select id="psize">
<option value="4">4 inch</option>
<option value="5">5 inch</option>
<option value="6">6 inch</option>
</select>
<input id="pqty" type="number" placeholder="Quantity produced">
<button onclick="saveProd()">Save Production</button>
</section>

<section id="sale" class="card" style="display:none">
<h3>üß± Block Sales</h3>
<input id="sdate" type="date">
<select id="ssize">
<option value="4">4 inch</option>
<option value="5">5 inch</option>
<option value="6">6 inch</option>
</select>
<input id="sqty" type="number" placeholder="Quantity sold">
<input id="sprice" type="number" placeholder="Price per block">
<button onclick="saveSale()">Save Sale</button>
</section>

<section id="exp" class="card" style="display:none">
<h3>üí∏ Expense</h3>
<input id="edate" type="date">
<input id="etype" placeholder="Expense type">
<input id="eamt" type="number" placeholder="Amount">
<button onclick="saveExpense()">Save Expense</button>
</section>

<section id="history" class="card" style="display:none">
<h3>üìú History</h3>
<div id="hlist"></div>
</section>

<section id="report" class="card" style="display:none"></section>

<script>
const ALERT_LEVEL = 30;
let store = JSON.parslet store =
  JSON.parse(localStorage.getItem("montblock_v31")) ||
  JSON.parse(localStorage.getItem("montblock_final")) ||
  JSON.parse(localStorage.getItem("montblock3")) ||
  {records:[]};

function todayStr(){
 let d=new Date();
 return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
}
function nowTime(){
 return new Date().toLocaleTimeString("en-US",{hour:'numeric',minute:'2-digit',hour12:true});
}
function fmtDate(d){
 let x=new Date(d);
 return `${String(x.getDate()).padStart(2,'0')}-${String(x.getMonth()+1).padStart(2,'0')}-${x.getFullYear()}`;
}
function save(){localStorage.setItem("montblock_v31",JSON.stringify(store));dashboard();}
function show(id){
["dash","cement","prod","sale","exp","history","report"].forEach(s=>document.getElementById(s).style.display="none");
document.getElementById(id).style.display="block";
if(id==="history")renderHistory();
if(id==="report")renderReport();
}
function add(r){store.records.push(r);save();}

function saveCementIn(){
 add({type:"cement_in",bags:+cbags.value,price:+cprice.value,date:fmtDate(cdate.value),time:nowTime()});
 cbags.value="";cprice.value="";
}
function saveCementOut(){
 add({type:"cement_out",bags:+coutbags.value,reason:coutreason.value,date:fmtDate(coutdate.value),time:nowTime()});
 coutbags.value="";coutreason.value="";
}
function saveProd(){
 add({type:"prod",size:psize.value,qty:+pqty.value,date:fmtDate(pdate.value),time:nowTime()});
 pqty.value="";
}
function saveSale(){
 add({type:"sale",size:ssize.value,qty:+sqty.value,price:+sprice.value,date:fmtDate(sdate.value),time:nowTime()});
 sqty.value="";sprice.value="";
}
function saveExpense(){
 add({type:"exp",name:etype.value,amt:+eamt.value,date:fmtDate(edate.value),time:nowTime()});
 etype.value="";eamt.value="";
}

function dashboard(){
 let cement=0,sales=0,exp=0,stock={4:0,5:0,6:0};
 store.records.forEach(r=>{
  if(r.type==="cement_in"){cement+=r.bags;exp+=r.bags*r.price;}
  if(r.type==="cement_out")cement-=r.bags;
  if(r.type==="prod")stock[r.size]+=r.qty;
  if(r.type==="sale"){stock[r.size]-=r.qty;sales+=r.qty*r.price;}
  if(r.type==="exp")exp+=r.amt;
 });
 dash.innerHTML=`
 <h3>üß± BLOCK STOCK</h3>
 <p>4" Blocks: <b>${stock[4]}</b></p>
 <p>5" Blocks: <b>${stock[5]}</b></p>
 <p>6" Blocks: <b>${stock[6]}</b></p>
 <hr>
 <h3>üèóÔ∏è CEMENT</h3>
 <p>Cement Stock: <b>${cement} bags</b></p>
 ${cement<ALERT_LEVEL?'<p class="alert">‚ö†Ô∏è Low cement stock</p>':''}
 <hr>
 <h3>üí∞ SUMMARY</h3>
 <p>Sales: <b>${sales.toLocaleString()}</b></p>
 <p>Expenses: <b>${exp.toLocaleString()}</b></p>
 <p><b>Profit: ${(sales-exp).toLocaleString()}</b></p>`;
}

function renderHistory(){
 let today=todayStr();
 hlist.innerHTML=store.records.map((r,i)=>`
 <p class="small">
 ${i+1}. ${r.type.replace("_"," ").toUpperCase()} | ${r.date} ${r.time}
 ${r.date===today?`<span class="edit" onclick="editRecord(${i})"> ‚úèÔ∏è Edit</span>`:''}
 </p>`).join("");
}

function editRecord(i){
 let r=store.records[i];
 if(r.type==="cement_in"){
  let b=prompt("Bags",r.bags);let p=prompt("Price",r.price);
  if(b&&p){r.bags=+b;r.price=+p;}
 }
 if(r.type==="cement_out"){
  let b=prompt("Bags",r.bags);
  if(b)r.bags=+b;
 }
 if(r.type==="prod"){
  let q=prompt("Quantity",r.qty);
  if(q)r.qty=+q;
 }
 if(r.type==="sale"){
  let q=prompt("Quantity",r.qty);let p=prompt("Price",r.price);
  if(q&&p){r.qty=+q;r.price=+p;}
 }
 if(r.type==="exp"){
  let a=prompt("Amount",r.amt);
  if(a)r.amt=+a;
 }
 save();renderHistory();
}

function renderReport(){
 let today=new Date().toISOString().slice(0,10);
 let weekStart=new Date();weekStart.setDate(weekStart.getDate()-weekStart.getDay());
 let month=today.slice(0,7);
 let daily=0,weekly=0,monthly=0;

 store.records.forEach(r=>{
  let d=r.date.split("-").reverse().join("-");
  if(d===today && r.type==="sale")daily+=r.qty*r.price;
  if(new Date(d)>=weekStart && r.type==="sale")weekly+=r.qty*r.price;
  if(d.startsWith(month) && r.type==="sale")monthly+=r.qty*r.price;
 });

 report.innerHTML=`
 <h3>üìä Reports</h3>
 <p>Today Sales: ${daily.toLocaleString()}</p>
 <p>This Week Sales: ${weekly.toLocaleString()}</p>
 <p>This Month Sales: ${monthly.toLocaleString()}</p>`;
}

function exportJSON(){
 let blob=new Blob([JSON.stringify(store)],{type:"application/json"});
 let a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="montblock-backup.json";
 a.click();
}

function importJSON(){
 let i=document.createElement("input");
 i.type="file";
 i.onchange=e=>{
  let r=new FileReader();
  r.onload=()=>{store=JSON.parse(r.result);save();};
  r.readAsText(e.target.files[0]);
 };
 i.click();
}

["cdate","coutdate","pdate","sdate","edate"].forEach(id=>{
 document.getElementById(id).value=new Date().toISOString().split("T")[0];
});

dashboard();
// FORCE INITIAL LOAD & SAFARI FIX
document.addEventListener("DOMContentLoaded", function () {
  show("dash");
});
</script>

</body>
</html>