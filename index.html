<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MONTBLOCK â€“ Factory System v1.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;margin:0;background:#f4f4f4}
header{background:#000;color:#fff;padding:15px;text-align:center;font-weight:bold}
nav{background:#ddd;padding:10px}
nav button{
  width:100%;margin:6px 0;padding:14px;
  background:#000;color:#fff;border:none;border-radius:6px;
  font-size:16px
}
section{display:none;padding:15px}
.card{background:#fff;padding:15px;border-radius:6px;margin-bottom:15px}
input,select,button{
  width:100%;padding:10px;margin:6px 0;
  border:1px solid #ccc;border-radius:5px;font-size:15px
}
hr{margin:15px 0}
.item{border-bottom:1px solid #ddd;padding:10px 0}
.small{font-size:13px;color:#555}
.exportBtn{background:#004aad;color:#fff}

.date-label{
  display:block;
  font-size:14px;
  color:#000;
  margin-bottom:4px;
  font-weight:bold;
}

@media print{
  nav,button{display:none}
  body{background:#fff}
}
</style>
</head>

<body>

<header>MONTBLOCK â€“ Factory System</header>

<nav>
<button onclick="show('dash')">Dashboard</button>
<button onclick="show('cement')">Cement</button>
<button onclick="show('prod')">Production</button>
<button onclick="show('sale')">Sales</button>
<button onclick="show('exp')">Expenses</button>
<button onclick="show('history')">History</button>
<button onclick="show('report')">Reports</button>
</nav>

<section id="dash" class="card">
<h3>Dashboard</h3>
<p><b>Cement Stock:</b> <span id="cstock">0</span> bags</p>
<hr>
<p>4" Blocks: <span id="b4">0</span></p>
<p>5" Blocks: <span id="b5">0</span></p>
<p>6" Blocks: <span id="b6">0</span></p>
<hr>
<p><b>Total Sales:</b> TZS <span id="tsales">0</span></p>
<p><b>Total Expenses:</b> TZS <span id="texp">0</span></p>
<p><b>Profit:</b> TZS <span id="profit">0</span></p>
</section>

<section id="history" class="card">
<h3>History (Latest First)</h3>
<div id="hlist"></div>
</section>

<section id="report" class="card">
<h3>Reports</h3>
<div id="rout"></div>
</section>

<script>
let db = JSON.parse(localStorage.getItem("montblock_v6")) || {
 cement:0,b4:0,b5:0,b6:0,sales:0,exp:0,log:[]
};

function show(id){
 document.querySelectorAll("section").forEach(s=>s.style.display="none");
 document.getElementById(id).style.display="block";
 if(id==="history") renderHistory();
 if(id==="report") genReport();
}

function render(){
 cstock.innerText = db.cement.toLocaleString();
 b4.innerText = db.b4.toLocaleString();
 b5.innerText = db.b5.toLocaleString();
 b6.innerText = db.b6.toLocaleString();
 tsales.innerText = db.sales.toLocaleString();
 texp.innerText = db.exp.toLocaleString();
 profit.innerText = (db.sales-db.exp).toLocaleString();
}

/* ðŸ”‘ CORE FIX: ensure total exists, then format */
function normalizeText(x){
 let txt = x.txt;

 // SALE: 60 @ 1000
 if(x.t==="Sale"){
   let m = txt.match(/(\d+)\s@\s(\d+)/);
   if(m){
     let total = m[1]*m[2];
     if(!txt.includes("=")) txt += " = " + total;
   }
 }

 // CEMENT IN: 100 bags @ 16750
 if(x.t==="Cement IN"){
   let m = txt.match(/(\d+)\s*bags?\s*@\s*(\d+)/i);
   if(m){
     let total = m[1]*m[2];
     if(!txt.includes("=")) txt += " = " + total;
   }
 }

 // FORMAT COMMAS
 let m2 = txt.match(/=\s*(\d+)/);
 if(m2){
   let formatted = Number(m2[1]).toLocaleString();
   txt = txt.replace(/=\s*\d+/, "= " + formatted);
 }

 return txt;
}

function renderHistory(){
 hlist.innerHTML="";
 db.log.forEach(x=>{
   let txt = normalizeText(x);
   hlist.innerHTML += `
     <div class="item">
       <b>${x.t}</b><br>${txt}
       <div class="small">${x.d}</div>
     </div>`;
 });
}

function genReport(){
 rout.innerHTML = db.log.map(x=>{
   return `${x.d} â€“ ${x.t}: ${normalizeText(x)}`;
 }).join("<br>");
}

window.onload=()=>{
 render();
 show("dash");
}
</script>

</body>
</html>