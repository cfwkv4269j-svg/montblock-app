<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MONTBLOCK – Factory System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;margin:0;background:#f4f4f4}
header{background:#000;color:#fff;padding:15px;text-align:center;font-weight:bold}
nav{background:#ddd;padding:10px}
nav button{width:100%;margin:6px 0;padding:14px;background:#000;color:#fff;border:none;border-radius:6px;font-size:16px}
section{display:none;padding:15px}
.card{background:#fff;padding:15px;border-radius:6px;margin-bottom:15px}
input,select,button{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:5px}
.item{border-bottom:1px solid #ddd;padding:10px 0}
.small{font-size:13px;color:#555}
.editBtn{background:#666;color:#fff}
.delBtn{background:#b00020;color:#fff}
</style>
</head>

<body>
<header>MONTBLOCK – Factory System</header>

<section id="login" class="card">
<h3>Login</h3>
<input id="lemail" type="email" placeholder="Email">
<input id="lpass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p class="small" id="lmsg"></p>
</section>

<nav id="nav" style="display:none">
<button onclick="show('dash')">Dashboard</button>
<button onclick="show('prod')">Production</button>
<button onclick="show('sale')">Sales</button>
<button onclick="show('exp')">Expenses</button>
<button onclick="show('history')">History</button>
<button onclick="show('report')">Reports</button>
</nav>

<section id="dash" class="card">
<h3>Dashboard</h3>
<p>Cement: <span id="cstock">0</span></p>
<p>4": <span id="b4">0</span> | 5": <span id="b5">0</span> | 6": <span id="b6">0</span></p>
<hr>
<p>Total Sales: TZS <span id="tsales">0</span></p>
<p>Total Expenses: TZS <span id="texp">0</span></p>
<p>Profit: TZS <span id="profit">0</span></p>
<p><b>Cash Balance:</b> TZS <span id="cash">0</span></p>
</section>

<section id="prod" class="card">
<h3>Production</h3>
<select id="psize"><option>4</option><option>5</option><option>6</option></select>
<input id="pqty" type="number" placeholder="Quantity">
<button onclick="saveProd()">Save</button>
</section>

<section id="sale" class="card">
<h3>Sales</h3>
<select id="ssize"><option>4</option><option>5</option><option>6</option></select>
<input id="sqty" type="number" placeholder="Quantity">
<input id="sprice" type="number" placeholder="Price">
<button onclick="saveSale()">Save</button>
</section>

<section id="exp" class="card">
<h3>Expense</h3>
<input id="etype" placeholder="Description">
<input id="eamt" type="number" placeholder="Amount">
<button onclick="saveExpense()">Save</button>
</section>

<section id="history" class="card">
<h3>History</h3>
<div id="hlist"></div>
</section>

<section id="report" class="card">
<h3>Report</h3>
<input type="date" id="rfrom">
<input type="date" id="rto">
<button onclick="genReport()">Generate</button>
<div id="rout"></div>
</section>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyD7gXGmqBejzmFt98ACn6PPXwB6CKqKkzI",
 authDomain:"montblock-factory-app-36ec4.firebaseapp.com",
 projectId:"montblock-factory-app-36ec4"
});

const auth=firebase.auth(), fs=firebase.firestore();
let ref, db={cement:0,b4:0,b5:0,b6:0,sales:0,exp:0,cash:0,log:[]};

const today=()=>new Date().toISOString().slice(0,10);
const daysBetween=d=>Math.floor((Date.now()-new Date(d))/86400000);

function login(){
 auth.signInWithEmailAndPassword(lemail.value,lpass.value)
 .catch(e=>lmsg.innerText=e.message);
}

auth.onAuthStateChanged(u=>{
 if(!u)return show('login');
 nav.style.display="block";
 ref=fs.collection("montblock").doc(u.uid);
 ref.get().then(d=>{ if(d.exists)db=d.data(); render(); show('dash'); });
});

function save(){ ref.set(db); render(); }

function saveProd(){
 let q=+pqty.value,s=psize.value;
 if(!q)return;
 db["b"+s]+=q;
 db.log.unshift({t:"Production",d:today(),q,s});
 save();
}

function saveSale(){
 let q=+sqty.value,p=+sprice.value,s=ssize.value;
 if(!q||!p)return;
 let amt=q*p;
 db["b"+s]-=q;
 db.sales+=amt;
 db.cash+=amt;
 db.log.unshift({t:"Sale",d:today(),q,s,p,amt});
 save();
}

function saveExpense(){
 let a=+eamt.value;
 if(!a)return;
 db.exp+=a;
 db.cash-=a;
 db.log.unshift({t:"Expense",d:today(),a,txt:etype.value});
 save();
}

function del(i){
 let x=db.log[i];
 if(daysBetween(x.d)>7) return alert("Can only delete within 7 days");
 if(x.t==="Sale"){ db.sales-=x.amt; db.cash-=x.amt; db["b"+x.s]+=x.q; }
 if(x.t==="Expense"){ db.exp-=x.a; db.cash+=x.a; }
 if(x.t==="Production"){ db["b"+x.s]-=x.q; }
 db.log.splice(i,1);
 save(); renderHistory();
}

function render(){
 cstock.innerText=db.cement;
 b4.innerText=db.b4; b5.innerText=db.b5; b6.innerText=db.b6;
 tsales.innerText=db.sales.toLocaleString();
 texp.innerText=db.exp.toLocaleString();
 profit.innerText=(db.sales-db.exp).toLocaleString();
 cash.innerText=db.cash.toLocaleString();
}

function renderHistory(){
 hlist.innerHTML="";
 db.log.forEach((x,i)=>{
  hlist.innerHTML+=`
  <div class="item">
   <b>${x.t}</b> — ${x.d}
   <div class="small">${JSON.stringify(x)}</div>
   <button class="delBtn" onclick="del(${i})">Delete</button>
  </div>`;
 });
}

function genReport(){
 let f=rfrom.value||"0000-00-00", t=rto.value||"9999-99-99";
 rout.innerHTML=db.log.filter(x=>x.d>=f&&x.d<=t)
 .map(x=>`${x.d} - ${x.t}`).join("<br>");
}

function show(id){
 document.querySelectorAll("section").forEach(s=>s.style.display="none");
 document.getElementById(id).style.display="block";
 if(id==="history") renderHistory();
}
</script>
</body>
</html>